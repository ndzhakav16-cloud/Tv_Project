
CREATE OR REPLACE VIEW FINAL_VIEWERSHIP_PROFILE AS

WITH bright_tv_user_profiles AS (
    SELECT
        UserID,
        Age,
        CASE WHEN gender = 'None' OR gender IS NULL THEN 'Unknown' ELSE gender END AS Gender,
        CASE WHEN race IN ('None', 'other') OR race IS NULL THEN 'Unknown' ELSE race END AS Race,
        CASE WHEN Province = 'None' OR Province IS NULL THEN 'Unknown' ELSE Province END AS MostViewingProvince,
        CASE 
            WHEN Age <= 0  THEN '01.Infant'
            WHEN Age BETWEEN 1 AND 12 THEN '02. 1-12 Kids'
            WHEN Age BETWEEN 13 AND 16 THEN '03. 13-16 Child'
            WHEN Age BETWEEN 17 AND 25 THEN '04. 17-25 Youth'
            WHEN Age BETWEEN 25 AND 35 THEN '05. 25-35 Young Adults'
            WHEN Age BETWEEN 35 AND 45 THEN '06. 35-45 Adults'
            WHEN Age >= 45 THEN '07. +46 Adults'
        END AS AgeGroup
    FROM bright_tv_user_profiles
),

viewership_data AS (
    SELECT
        UserID,
        Channel2,
        to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm') AS RecordDate,
        date_format(to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm'), 'HH:mm:ss') AS Watch_Starting_Time,
        to_date(to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm')) AS Watch_Date,
        date_format(to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm'), 'EEEE') AS Day_Name,
        CASE 
            WHEN dayofweek(to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm')) IN (1, 7) THEN 'Weekend'
            ELSE 'Weekday'
        END AS Day_Classification,
        date_format(to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm'), 'MMMM') AS Month_Name,
        year(to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm')) AS Year,
        hour(to_timestamp(RecordDate2, 'yyyy/MM/dd HH:mm')) AS Hour_of_Day
    FROM bright_tv_viewership_1
)

SELECT
    u.UserID,
    u.Age,
    u.Gender,
    u.Race,
    u.MostViewingProvince,
    u.AgeGroup,
    v.Channel2,
    v.Watch_Starting_Time,
    v.Watch_Date,
    v.Day_Name,
    v.Day_Classification,
    v.Month_Name,
    v.Year,
    v.Hour_of_Day
FROM bright_tv_user_profiles u
JOIN viewership_data v 
    ON u.UserID = v.UserID
LIMIT 100;


SELECT * FROM FINAL_VIEWERSHIP_PROFILE;
